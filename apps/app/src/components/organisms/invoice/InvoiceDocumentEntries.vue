<template>
    <div class="mb-4">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium text-gray-700">
                {{ title }}
            </h3>
            <button
                type="button"
                class="px-2 py-1 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700"
                @click="addEntry"
            >
                + {{ addButtonLabel }}
            </button>
        </div>

        <div class="border border-gray-300 rounded">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                            {{ t("invoice.documents.headers.file") }}
                        </th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                            {{ t("invoice.documents.headers.date") }}
                        </th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                            {{ t("invoice.documents.headers.amount") }}
                        </th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                            {{ t("invoice.documents.headers.remark") }}
                        </th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                            {{ t("common.actions") }}
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <tr v-if="!entries.length">
                        <td class="px-4 py-3 text-sm text-gray-500" colspan="5">
                            {{ emptyStateLabel }}
                        </td>
                    </tr>
                    <tr v-for="(entry, index) in entries" :key="index">
                        <td class="px-4 py-2 text-sm text-gray-900">
                            <DocumentUploadField
                                :required="!entry.file"
                                :file-name="entry.file"
                                :display-name="displayFileName(entry.file)"
                                :accept="accept"
                                :upload-label="t('invoice.documents.actions.upload')"
                                :replace-label="t('invoice.documents.actions.replace')"
                                :remove-label="t('common.remove')"
                                @select="(file) => handleFileSelected(index, file)"
                                @clear="() => clearFile(index)"
                            >
                                <template #preview>
                                    <button
                                        v-if="previewUrl(entry.file)"
                                        type="button"
                                        class="text-blue-600 hover:underline"
                                        @click="downloadFile(entry.file)"
                                    >
                                        {{ t("common.view") }}
                                    </button>
                                </template>
                            </DocumentUploadField>
                        </td>
                        <td class="px-4 py-2 text-sm text-gray-900">
                            <Input
                                type="date"
                                :modelValue="formatDateValue(entry.date)"
                                :required="Boolean(entry.file)"
                                @update:modelValue="(value) => updateEntry(index, 'date', value)"
                            />
                        </td>
                        <td class="px-4 py-2 text-sm text-gray-900">
                            <Input
                                type="number"
                                :modelValue="formatAmount(entry.amount)"
                                :required="Boolean(entry.file)"
                                @update:modelValue="(value) => updateEntry(index, 'amount', value)"
                            />
                        </td>
                        <td class="px-4 py-2 text-sm text-gray-900">
                            <Input
                                type="text"
                                :modelValue="entry.remark || ''"
                                @update:modelValue="(value) => updateEntry(index, 'remark', value)"
                            />
                        </td>
                        <td class="px-4 py-2 text-sm text-gray-900">
                            <Button
                                type="button"
                                variant="danger"
                                size="sm"
                                @click="removeEntry(index)"
                            >
                                X
                            </Button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</template>

<script setup lang="ts">
import { computed } from "vue"
import { useI18n } from "vue-i18n"
import Input from "@/components/atoms/Input.vue"
import DocumentUploadField from "@/components/molecules/DocumentUploadField.vue"
import { useInvoiceDocuments } from "@/composables/invoice/useInvoiceDocuments"
import Button from "@/components/atoms/Button.vue"

export interface InvoiceDocumentEntry {
    file: string
    date?: string | Date | null
    amount?: number | null
    remark?: string | null
}

const props = defineProps<{
    title: string
    addButtonLabel: string
    emptyStateLabel: string
    entryType: "offer" | "adjudication"
    modelValue: InvoiceDocumentEntry[]
    accept?: string
}>()

const emit = defineEmits<{
    (e: "update:modelValue", value: InvoiceDocumentEntry[]): void
    (e: "file-change", value: { index: number; file: File | null }): void
    (e: "entry-removed", value: { index: number }): void
}>()

const { t } = useI18n()
const { buildFileUrl, downloadInvoiceFile, extractFileName } = useInvoiceDocuments()

const entries = computed({
    get: () => props.modelValue || [],
    set: (value: InvoiceDocumentEntry[]) => emit("update:modelValue", value),
})

const accept = computed(() => props.accept || ".pdf,.doc,.docx,.xls,.xlsx")

const addEntry = () => {
    entries.value = [
        ...entries.value,
        {
            file: "",
            date: "",
            amount: null,
            remark: "",
        },
    ]
}

const removeEntry = (index: number) => {
    const updated = [...entries.value]
    updated.splice(index, 1)
    entries.value = updated
    emit("file-change", { index, file: null })
    emit("entry-removed", { index })
}

const updateEntry = (index: number, field: keyof InvoiceDocumentEntry, value: unknown) => {
    const updated = [...entries.value]
    const entry = { ...updated[index] }

    if (field === "amount") {
        const parsed = typeof value === "string" ? parseFloat(value) : Number(value)
        entry.amount = Number.isFinite(parsed) ? parsed : null
    } else if (field === "date") {
        entry.date = value as string
    } else if (field === "file") {
        entry.file = (value as string) || ""
    } else if (field === "remark") {
        entry.remark = (value as string) || ""
    }

    updated[index] = entry
    entries.value = updated
}

const clearFile = (index: number) => {
    updateEntry(index, "file", "")
    emit("file-change", { index, file: null })
}

const handleFileSelected = (index: number, file: File | null) => {
    updateEntry(index, "file", file ? file.name : "")
    emit("file-change", { index, file })
}

const isStoredFile = (file?: string | null) => {
    if (!file) return false
    const value = file.trim()
    if (!value) return false
    return value.includes("/") || value.includes("\\")
}

const previewUrl = (file?: string | null) => {
    if (!isStoredFile(file)) return null
    return buildFileUrl(file)
}

const downloadFile = (file?: string | null) => downloadInvoiceFile(file)

const displayFileName = (file?: string | null) => extractFileName(file)

const formatDateValue = (value: InvoiceDocumentEntry["date"]) => {
    if (!value) return ""
    if (!(value instanceof Date)) {
        try {
            value = new Date(value)
        } catch (e) {}
    }
    if (!(value instanceof Date)) {
        return value
    }
    return value.toISOString().split("T")[0]
}

const formatAmount = (value: InvoiceDocumentEntry["amount"]) => {
    if (value === null || value === undefined) return ""
    return String(value)
}
</script>
